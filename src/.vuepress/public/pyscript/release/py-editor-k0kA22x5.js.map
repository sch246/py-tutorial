{"version":3,"file":"py-editor-k0kA22x5.js","sources":["../src/plugins/py-editor.js"],"sourcesContent":["// PyScript py-editor plugin\nimport { Hook, XWorker, dedent } from \"polyscript/exports\";\nimport { TYPES } from \"../core.js\";\n\nconst RUN_BUTTON = `<svg style=\"height:20px;width:20px;vertical-align:-.125em;transform-origin:center;overflow:visible;color:green\" viewBox=\"0 0 384 512\" aria-hidden=\"true\" role=\"img\" xmlns=\"http://www.w3.org/2000/svg\"><g transform=\"translate(192 256)\" transform-origin=\"96 0\"><g transform=\"translate(0,0) scale(1,1)\"><path d=\"M361 215C375.3 223.8 384 239.3 384 256C384 272.7 375.3 288.2 361 296.1L73.03 472.1C58.21 482 39.66 482.4 24.52 473.9C9.377 465.4 0 449.4 0 432V80C0 62.64 9.377 46.63 24.52 38.13C39.66 29.64 58.21 29.99 73.03 39.04L361 215z\" fill=\"currentColor\" transform=\"translate(-192 -256)\"></path></g></g></svg>`;\n\nlet id = 0;\nconst getID = (type) => `${type}-editor-${id++}`;\n\nconst envs = new Map();\n\nconst hooks = {\n    worker: {\n        // works on both Pyodide and MicroPython\n        onReady: ({ runAsync, io }, { sync }) => {\n            io.stdout = (line) => sync.write(line);\n            io.stderr = (line) => sync.writeErr(line);\n            sync.revoke();\n            sync.runAsync = runAsync;\n        },\n    },\n};\n\nfunction cleanErrorMessage(errorMsg) {\n    // 删除指定部分\n    let cleanedMsg = errorMsg.replace(/Error: Traceback \\(most recent call last\\):[\\s\\S]*?File \"<exec>\"/, 'Error: Traceback (most recent call last):\\n  File \"<exec>\"');\n\n    // 为 < 和 > 添加反斜杠\n    cleanedMsg = cleanedMsg.replace(/</g, '\\\\<').replace(/>/g, '\\\\>');\n\n    return cleanedMsg;\n}\n\nasync function execute({ currentTarget }) {\n    const { env, pySrc, outDiv } = this;\n\n    currentTarget.disabled = true;\n    outDiv.innerHTML = \"\";\n\n    if (!envs.has(env)) {\n        const srcLink = URL.createObjectURL(new Blob([\"\"]));\n        const xworker = XWorker.call(new Hook(null, hooks), srcLink, {\n            type: this.interpreter,\n        });\n\n        const { sync } = xworker;\n        const { promise, resolve } = Promise.withResolvers();\n        envs.set(env, promise);\n        sync.revoke = () => {\n            URL.revokeObjectURL(srcLink);\n            resolve(xworker);\n        };\n    }\n\n    // wait for the env then set the target div\n    // before executing the current code\n    envs.get(env).then((xworker) => {\n        xworker.onerror = ({ error }) => {\n            let str = `${error.message || error}`\n            outDiv.innerHTML += `<span style='color:red'>${\n                cleanErrorMessage(str)\n            }</span>\\n`;\n            console.error(error);\n        };\n\n        const enable = () => {\n            currentTarget.disabled = false;\n        };\n        const { sync } = xworker;\n        sync.write = (str) => {\n            outDiv.innerText += `${str}\\n`;\n        };\n        sync.writeErr = (str) => {\n            outDiv.innerHTML += `<span style='color:red'>${cleanErrorMessage(str)}</span>\\n`;\n        };\n        sync.runAsync(pySrc).then(enable, enable);\n    });\n}\n\nconst makeRunButton = (listener, type) => {\n    const runButton = document.createElement(\"button\");\n    runButton.className = `absolute ${type}-editor-run-button`;\n    runButton.innerHTML = RUN_BUTTON;\n    runButton.setAttribute(\"aria-label\", \"Python Script Run Button\");\n    runButton.addEventListener(\"click\", listener);\n    return runButton;\n};\n\nconst makeEditorDiv = (listener, type) => {\n    const editorDiv = document.createElement(\"div\");\n    editorDiv.className = `${type}-editor-input`;\n    editorDiv.setAttribute(\"aria-label\", \"Python Script Area\");\n\n    const runButton = makeRunButton(listener, type);\n    const editorShadowContainer = document.createElement(\"div\");\n\n    // avoid outer elements intercepting key events (reveal as example)\n    editorShadowContainer.addEventListener(\"keydown\", (event) => {\n        event.stopPropagation();\n    });\n\n    editorDiv.append(runButton, editorShadowContainer);\n\n    return editorDiv;\n};\n\nconst makeOutDiv = (type) => {\n    const outDiv = document.createElement(\"div\");\n    outDiv.className = `${type}-editor-output`;\n    outDiv.id = `${getID(type)}-output`;\n    return outDiv;\n};\n\nconst makeBoxDiv = (listener, type) => {\n    const boxDiv = document.createElement(\"div\");\n    boxDiv.className = `${type}-editor-box`;\n\n    const editorDiv = makeEditorDiv(listener, type);\n    const outDiv = makeOutDiv(type);\n    boxDiv.append(editorDiv, outDiv);\n\n    return [boxDiv, outDiv];\n};\n\nconst init = async (script, type, interpreter) => {\n    const [\n        { basicSetup, EditorView },\n        { Compartment },\n        { python },\n        { indentUnit },\n        { keymap },\n        { defaultKeymap },\n    ] = await Promise.all([\n        // TODO: find a way to actually produce these bundles locally\n        import(/* webpackIgnore: true */ \"../3rd-party/codemirror.js\"),\n        import(/* webpackIgnore: true */ \"../3rd-party/codemirror_state.js\"),\n        import(\n            /* webpackIgnore: true */ \"../3rd-party/codemirror_lang-python.js\"\n        ),\n        import(/* webpackIgnore: true */ \"../3rd-party/codemirror_language.js\"),\n        import(/* webpackIgnore: true */ \"../3rd-party/codemirror_view.js\"),\n        import(/* webpackIgnore: true */ \"../3rd-party/codemirror_commands.js\"),\n    ]);\n\n    const selector = script.getAttribute(\"target\");\n\n    let target;\n    if (selector) {\n        target =\n            document.getElementById(selector) ||\n            document.querySelector(selector);\n        if (!target) throw new Error(`Unknown target ${selector}`);\n    } else {\n        target = document.createElement(`${type}-editor`);\n        target.style.display = \"block\";\n        script.after(target);\n    }\n\n    if (!target.id) target.id = getID(type);\n    if (!target.hasAttribute(\"exec-id\")) target.setAttribute(\"exec-id\", 0);\n    if (!target.hasAttribute(\"root\")) target.setAttribute(\"root\", target.id);\n\n\n    const env = `${interpreter}-${script.getAttribute(\"env\") || getID(type)}`;\n    const context = {\n        interpreter,\n        env,\n        get pySrc() {\n            return editor.state.doc.toString();\n        },\n        get outDiv() {\n            return outDiv;\n        },\n    };\n\n    // @see https://github.com/JeffersGlass/mkdocs-pyscript/blob/main/mkdocs_pyscript/js/makeblocks.js\n    const listener = execute.bind(context);\n    const [boxDiv, outDiv] = makeBoxDiv(listener, type);\n    boxDiv.dataset.env = script.hasAttribute(\"env\") ? env : interpreter;\n\n    const inputChild = boxDiv.querySelector(`.${type}-editor-input > div`);\n    const parent = inputChild.attachShadow({ mode: \"open\" });\n    // avoid inheriting styles from the outer component\n    parent.innerHTML = `<style> :host { all: initial; }</style>`;\n\n    target.appendChild(boxDiv);\n\n    const doc = dedent(script.textContent).trim();\n\n    // preserve user indentation, if any\n    const indentation = /^(\\s+)/m.test(doc) ? RegExp.$1 : \"    \";\n\n    const editor = new EditorView({\n        extensions: [\n            indentUnit.of(indentation),\n            new Compartment().of(python()),\n            keymap.of([\n                ...defaultKeymap,\n                { key: \"Ctrl-Enter\", run: listener, preventDefault: true },\n                { key: \"Cmd-Enter\", run: listener, preventDefault: true },\n                { key: \"Shift-Enter\", run: listener, preventDefault: true },\n            ]),\n            basicSetup,\n        ],\n        parent,\n        doc,\n    });\n\n    // editor.focus();\n};\n\n// avoid too greedy MutationObserver operations at distance\nlet timeout = 0;\n\n// reset interval value then check for new scripts\nconst resetTimeout = () => {\n    timeout = 0;\n    pyEditor();\n};\n\n// triggered both ASAP on the living DOM and via MutationObserver later\nconst pyEditor = async () => {\n    if (timeout) return;\n    timeout = setTimeout(resetTimeout, 250);\n    for (const [type, interpreter] of TYPES) {\n        const selector = `pre[type=\"${type}-editor\"],script[type=\"${type}-editor\"]`;\n        for (const script of document.querySelectorAll(selector)) {\n            // avoid any further bootstrap\n            script.type += \"-active\";\n            await init(script, type, interpreter);\n            if (script.parentNode){\n                script.parentNode.removeChild(script)\n            }\n        }\n    }\n};\n\nnew MutationObserver(pyEditor).observe(document, {\n    childList: true,\n    subtree: true,\n});\n\n// try to check the current document ASAP\nexport default pyEditor();\n"],"names":["id","getID","type","envs","Map","hooks","worker","onReady","runAsync","io","sync","stdout","line","write","stderr","writeErr","revoke","cleanErrorMessage","errorMsg","cleanedMsg","replace","async","execute","currentTarget","env","pySrc","outDiv","this","disabled","innerHTML","has","srcLink","URL","createObjectURL","Blob","xworker","XWorker","call","Hook","interpreter","promise","resolve","Promise","withResolvers","set","revokeObjectURL","get","then","onerror","error","str","message","console","enable","innerText","makeEditorDiv","listener","editorDiv","document","createElement","className","setAttribute","runButton","addEventListener","makeRunButton","editorShadowContainer","event","stopPropagation","append","makeBoxDiv","boxDiv","makeOutDiv","init","script","basicSetup","EditorView","Compartment","python","indentUnit","keymap","defaultKeymap","all","import","n","x","q","selector","getAttribute","target","getElementById","querySelector","Error","style","display","after","hasAttribute","context","editor","state","doc","toString","bind","dataset","parent","attachShadow","mode","appendChild","dedent","textContent","trim","indentation","test","RegExp","$1","extensions","of","key","run","preventDefault","timeout","resetTimeout","pyEditor","setTimeout","TYPES","querySelectorAll","parentNode","removeChild","MutationObserver","observe","childList","subtree","pyEditor$1"],"mappings":"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"}